#!/usr/bin/env bash

# Set Some Variables
COLXML='/etc/columnstore/Columnstore.xml'
IFLAG='/etc/columnstore/container-initialized'
LOG_PREFIX='/var/log/mariadb/columnstore'
MCS_INSTALL_BIN='/usr/bin'
CMAPI_KEY="${CMAPI_KEY:-somekey123}"
SKYSQL_INITIALIZATION="${SKYSQL_INITIALIZATION:-0}"
RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

# Intialize Container If Necessary
if [[ ! -e ${IFLAG} ]]; then
    if ! "${MCS_INSTALL_BIN}"/columnstore-init &> "${LOG_PREFIX}"/columnstore-init.log; then
        echo "ERROR: During Initialization."
        exit 1
    fi
fi

# Begin
echo -e "${CYAN}***** Starting ColumnStore System *****${NC}"

# Dynamic Memory Allocation
if [[ "${SKYSQL_INITIALIZATION}" == 1 ]]; then
    MEMORY_PCT_LIMIT="${MEMORY_PCT_LIMIT:-90}"
    MAX_RAM_KB=$(grep MemTotal /proc/meminfo | cut -d':' -f2 | sed 's/ //g;s/[^0-9]//g')
    MAX_RAM=$((MAX_RAM_KB*MEMORY_PCT_LIMIT/100/1024))
    TOTALUMMEMORY=$( echo "${MAX_RAM}" / 4  | bc )M
    NUMBLOCKSPCT=$( echo "${MAX_RAM}" / 2  | bc )M
fi

# Start CMAPI & Columnstore
touch "${LOG_PREFIX}"/cmapi_server.log && chmod 666 "${LOG_PREFIX}"/cmapi_server.log
cd /usr/share/columnstore/cmapi || exit
if PYTHONPATH=/usr/share/columnstore/cmapi/deps /usr/share/columnstore/cmapi/python/bin/python3 -m cmapi_server &> /dev/null &
then
    echo -e "Starting Cluster Manager API... ${GREEN}done${NC}"
else
    echo -e "Starting Cluster Manager API... ${RED}fail${NC}"
    exit 1
fi


# Performance Tuning
xmlstarlet ed -L -u '/Columnstore/HashJoin/TotalUmMemory' -v "${TOTALUMMEMORY}" "${COLXML}"
xmlstarlet ed -L -u '/Columnstore/DBBC/NumBlocksPct' -v "${NUMBLOCKSPCT}" "${COLXML}"

# Start MariaDB
mariadb-admin ping > /dev/null 2>&1
if ! mariadb-admin ping > /dev/null 2>&1; then
    if mariadbd-safe > /dev/null 2>&1 &
    then
        echo -e "Starting MariaDB Server... ${GREEN}done${NC}"
    else
        echo -e "Starting MariaDB Server... ${RED}fail${NC}"
        exit 1
    fi
    sleep 5
fi

exit 0
